#internship_container.def
Bootstrap: debootstrap
OSVersion: buster
MirrorURL: http://deb.debian.org/debian
Include: vim
%setup
%files
%environment
%runscript
%post
    # update everything
    apt --yes update && apt --yes --force-yes upgrade
    # install tools required for building from source or installation without apt
    apt --yes install build-essential
    apt --yes install gdebi-core
    apt --yes install curl
    apt --yes install wget
    apt --yes install zip
    apt --yes install unzip
    ########################
    # install conda #
    ########################
    wget https://repo.anaconda.com/archive/Anaconda3-2019.07-Linux-x86_64.sh
    bash Anaconda3-2019.07-Linux-x86_64.sh -b -p /opt/anaconda3
    chmod +x /opt/anaconda3/bin/conda
    ln -s /opt/anaconda3/bin/conda /usr/local/bin/conda
    rm Anaconda3-2019.07-Linux-x86_64.sh
    # install python tools
    /opt/anaconda3/bin/conda config --add channels defaults
    /opt/anaconda3/bin/conda config --add channels bioconda
    /opt/anaconda3/bin/conda config --add channels conda-forge
    /opt/anaconda3/bin/conda create -n scanpyenv scanpy=1.8.1 python=3.7
    /opt/anaconda3/bin/conda create -n scvelo_env scvelo=0.2.3 python=3.7
    /opt/anaconda3/bin/conda create -n scrublet_env scrublet=0.2.3 python=3.7
    /opt/anaconda3/bin/conda init bash
    #########################
    # install java tools    #
    #########################
    wget -qO - https://adoptopenjdk.jfrog.io/adoptopenjdk/api/gpg/key/public | apt-key add - # the key for openjdk
    # we need this package to allow adding of repositories
    apt --yes install software-properties-common
    apt --yes update
    # we need to add a repository for this one
    add-apt-repository --yes https://adoptopenjdk.jfrog.io/adoptopenjdk/deb/
    apt --yes update && apt --yes install adoptopenjdk-8-hotspot
    # openjdk 11 however, is in the standard repos
    apt --yes install openjdk-11-jdk
    apt --yes install maven
    apt --yes install git
    git clone https://github.com/molgenis/systemsgenetics.git
    cd ./systemsgenetics
    git checkout 34096bdbaae723d438d9167d962806efeb0b63e1
    # increase memory for maven
    export MAVEN_OPTS="-Xmx4096m -XX:MaxPermSize=4096m"
    # build the projects
    mvn package -DskipTests
    mkdir -p /opt/systemsgenetics/GenotypeHarmonizer/
    cp ./Genotype-Harmonizer/target/GenotypeHarmonizer-1.4.23-SNAPSHOT.jar /opt/systemsgenetics/GenotypeHarmonizer/GenotypeHarmonizer.jar
    echo "#/bin/bash" > /opt/systemsgenetics/GenotypeHarmonizer/GenotypeHarmonizer.sh
    echo "java -jar /opt/systemsgenetics/GenotypeHarmonizer/GenotypeHarmonizer.jar '$@'" >> /opt/systemsgenetics/GenotypeHarmonizer/GenotypeHarmonizer.sh
    chmod +x /opt/systemsgenetics/GenotypeHarmonizer/GenotypeHarmonizer.sh
    ln -s /opt/systemsgenetics/GenotypeHarmonizer/GenotypeHarmonizer.sh /usr/local/bin/GenotypeHarmonizer
    mkdir -p /opt/systemsgenetics/eqtl-mapping-pipeline/
    cp ./eqtl-mapping-pipeline/target/eqtl-mapping-pipeline-1.4.9a-SNAPSHOT.jar /opt/systemsgenetics/eqtl-mapping-pipeline/eqtl-mapping-pipeline.jar
    echo "#/bin/bash" > /opt/systemsgenetics/eqtl-mapping-pipeline/eqtl-mapping-pipeline.sh
    echo "java -jar /opt/systemsgenetics/eqtl-mapping-pipeline/eqtl-mapping-pipeline.jar" '$@'>> /opt/systemsgenetics/eqtl-mapping-pipeline/eqtl-mapping-pipeline.sh
    chmod +x /opt/systemsgenetics/eqtl-mapping-pipeline/eqtl-mapping-pipeline.sh
    ln -s /opt/systemsgenetics/eqtl-mapping-pipeline/qtl-mapping-pipeline.sh /usr/local/bin/qtl-mapping-pipeline
    cd ../
    rm -r systemsgenetics
    #########################
    #   Install python
    #########################
    apt --yes install python3.7
    #########################
    #   BWA
    #########################
    #https://sourceforge.net/projects/bio-bwa/files/
    apt --yes install bwa
    #########################
    #   samtools
    #########################
    #https://sourceforge.net/projects/samtools/files/samtools/1.13/
    apt --yes install samtools
    #########################
    #   Picard - #https://gatk.broadinstitute.org/hc/en-us/articles/360041320571--How-to-Install-all-software-packages-required-to-follow-the-GATK-Best-Practices
    #########################
    #https://github.com/broadinstitute/picard/releases/
    wget https://github.com/broadinstitute/picard/releases/download/2.26.3/picard.jar
    # apt-get --yes install openjdk
    #apt-get install openjdk-8-jre-headless
    mkdir /opt/picard
    # copy to opt (were more apps are installed)
    cp picard.jar /opt/picard/
    #nano /opt/picard/picard.sh
    echo "#!/bin/bash" > /opt/picard/picard.sh
    echo 'java -jar /opt/picard/picard.jar "$@"' >> /opt/picard/picard.sh
    chmod +x /opt/picard/picard.sh
    # symlink so available from anywhere in terminal
    ln -s /opt/picard/picard.sh /usr/local/bin/picard
    #########################
    #   GATK - #https://gatk.broadinstitute.org/hc/en-us/articles/360041320571--How-to-Install-all-software-packages-required-to-follow-the-GATK-Best-Practices
    #########################
    wget https://github.com/broadinstitute/gatk/releases/download/4.2.2.0/gatk-4.2.2.0.zip
    # unzip
    unzip gatk-4.2.2.0.zip
    # rename to basename
    mv gatk-4.2.2.0 gatk
    # copy to opt (were more apps are installed)
    cp -r gatk /opt/
    # make executable
    chmod +x /opt/gatk/gatk
    # symlink so available from anywhere in terminal
    ln -s /opt/gatk/gatk /usr/local/bin/gatk
    #########################
    #   bowtie2
    #########################
    #https://zoomadmin.com/HowToInstall/UbuntuPackage/bowtie2
    apt --yes install bowtie2
    #########################
    #   fastqc
    #########################
    apt --yes install fastqc
    #########################
    #   cutadapt
    #########################
    #https://cutadapt.readthedocs.io/en/stable/installation.html
    apt --yes install cutadapt
    #########################
    #   bcftools
    #########################
    apt --yes install bcftools
    #########################
    # fastx https://bioinformaticsreview.com/20201109/installing-fastx-toolkit-on-ubuntu/
    #########################
    mkdir fastx_toolkit
    cd fastx_toolkit/
    wget http://hannonlab.cshl.edu/fastx_toolkit/fastx_toolkit_0.0.13_binaries_Linux_2.6_amd64.tar.bz2
    tar -xf fastx_toolkit_0.0.13_binaries_Linux_2.6_amd64.tar.bz2
    rm fastx_toolkit_0.0.13_binaries_Linux_2.6_amd64.tar.bz2
    chmod +x ./bin/*
    cd ../
    cp -r fastx_toolkit /opt
    ln -s /opt/fastx_toolkit/bin/* /usr/local/bin/